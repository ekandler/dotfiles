#!/usr/bin/python2.7
from facepy import GraphAPI
from pprint import pprint

oauth_access_token = "CAACEdEose0cBAHq2g1vKvSYSjTESoDVgZBjZBCT96aGZAi6lK4fArfZBk3eCBIPIeoIH6Re60UJuqgZBt5DDZBJJS0ECaI5U8GkpbZCP4Xl6ZAbXYyZBCVzzXKTrmvYomPc2ryGtZC7VE6ByQwGCQKSqdRZB7YG96pHZB140YEX32y1D4kXvS7ZCMIroVAs0CUmkLINYgAgHhPcZAIsgZDZD"

id_link_prefix = "https://developers.facebook.com/tools/explorer?method=GET&path="

# Initialize the Graph API with a valid access token (optional,
# but will allow you to do all sorts of fun stuff).
graph = GraphAPI(oauth_access_token)

htmlheader = '<html>\
<head>\
<link rel="stylesheet" type="text/css" href="style.css">\
</head>\
<body>'

htmlfooter = '\
</body>\
</html>'

tableheader = '<table>\
<tr>\
<th>created_time</th>\
<th>from</th>\
<th>message</th>\
<th>icon</th>\
<th>link</th>\
</tr>'

tablefooter = '</table>'


outfile_prefix = 'output'
outfile_postfix = '.html'

# parameters
params = "fields=picture,link,from,type,created_time,picture,comments.fields(message,created_time,from,like_count),message,likes.limit(1000),object_id&limit=200"

groupid = "227298601106"


def doexport(graphlink, filenr = 0):

    outfile = outfile_prefix + "_" + str(filenr) + outfile_postfix
# open file
    f = open(outfile, 'w')
    f.write(htmlheader)
    f.write(tableheader)



# Get my latest posts
    result = graph.get(graphlink)


#pprint (result['data'][0])
    for element in result['data']:
        if not 'link' in element: element['link'] = ''
        if not 'message' in element: element['message'] = ''
        if not 'comments' in element: element['comments'] = {'data':[]}
        if 'picture' in element: element['icon'] = '<img src="' + element['picture'] + '"/>' 
        else: element['icon'] = ''
        f.write('<tr class="%s">\
                <td class="time"><a href="%s">%s</a></td>\
                <td>%s</td>\
                <td>%s</td>\
                <td>%s</td>\
                <td><a href="%s">%s</a></td></tr>'\
                \
                % (element['type'], \
                id_link_prefix+element['id'], element['created_time'].replace('T', ' ').replace('+0000', ''),\
                element['from']['name'].encode('iso-8859-1','replace'), \
                element['message'].encode('iso-8859-1','replace'), \
                element['icon'], \
                element['link'].encode('iso-8859-1','replace'), element['link'].encode('iso-8859-1','replace')))
        for comment in element['comments']['data']:
            if not 'link' in comment: comment['link'] = ''
            if 'picture' in comment: comment['icon'] = '<img src="' + comment['picture'] + '"/>' 
            else: comment['icon'] = ''
            f.write('<tr class="comment">\
                    <td class="time"><a href="%s">%s</a></td>\
                    <td>%s</td>\
                    <td>%s</td>\
                    <td>%s</td>\
                    <td><a href="%s">%s</a></td></tr>'\
                    \
                    % (id_link_prefix+comment['id'], comment['created_time'].replace('T', ' ').replace('+0000', ''),\
                    comment['from']['name'].encode('iso-8859-1','replace'), \
                    comment['message'].encode('iso-8859-1','replace'), \
                    comment['icon'],
                    comment['link'], comment['link']))
    f.close()

    if 'paging' in result:
        print (result['paging']['next'].replace('https://graph.facebook.com', ''))
        doexport(result['paging']['next'].replace('https://graph.facebook.com', ''), filenr+1)

doexport('/'+groupid+'/feed?' + params)
